name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write

jobs:
  lint:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Install SwiftFormat
      run: brew install swiftformat

    - name: Run SwiftLint
      run: swiftlint lint --strict

    - name: Check SwiftFormat
      run: swiftformat --lint .

  build:
    runs-on: macos-14
    needs: lint
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: swift build -c release

  test:
    runs-on: macos-14
    needs: build
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Run tests
      run: swift test --enable-code-coverage

    - name: Generate coverage report
      run: |
        xcrun llvm-cov export -format="lcov" \
          .build/debug/UnmissablePackageTests.xctest/Contents/MacOS/UnmissablePackageTests \
          -instr-profile=.build/debug/codecov/default.profdata > coverage.lcov

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.lcov
        fail_ci_if_error: false

  # Notify on failure - creates/updates GitHub issue
  notify-failure:
    name: Notify Build Failure
    runs-on: macos-14
    needs: [lint, build, test]
    if: failure() && github.event.pull_request == null
    steps:
    - name: Create or update failure issue
      uses: jayqi/failed-build-issue-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        title-template: "CI Build Failure: {{workflow}} on {{refname}}"
        body-template: |
          ## Build Failure Detected

          **Workflow:** {{workflow}} #{{runNumber}}
          **Branch:** [{{refname}}](https://github.com/{{repo.owner}}/{{repo.repo}}/tree/{{refname}})
          **Commit:** [{{sha}}](https://github.com/{{repo.owner}}/{{repo.repo}}/commit/{{sha}})
          **Run:** [View workflow run](https://github.com/{{repo.owner}}/{{repo.repo}}/actions/runs/{{runId}})

          ### Failed Jobs
          One or more jobs failed in this workflow run. Check the workflow run link above for details.

          ### Next Steps
          1. Review the failed job logs
          2. Fix the issue and push a new commit
          3. Close this issue once the build passes
